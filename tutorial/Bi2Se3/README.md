# Bi<sub>2</sub>Se<sub>3</sub>: diagnosing topology

In this tutorial, we will use IrRep to classify the topology of Bi<sub>2</sub>Se<sub>3</sub>. We will use as input DFT data obtained with the [Quantum Espresso](https://www.quantum-espresso.org). The data is in the out directory. The input files for Quantum Espresso necessary to obtain this data ca be found in the directory `inputs`.

**Exercises:**

- [Exercise 1: Identify the space group](#identification-of-the-space-group)
- [Exercise 2: Calculate the irreducible representations at maximal k-points](#irreducible-representations-at-maximal-k-points)
- [Exercise 3: Diagnose the topology of valence bands](#diagnosing-topology-of-valence-bands)
- [Exercise 4: Separate wave functions by inversion eigenvalues](#separating-states-by-inversion-eigenvalues)

## Identification of the space group

If we look into the input files for Quantum Espresso, we notice that the lattice vectors specified for Bi<sub>2</sub>Se<sub>3</sub> belong to a rhombohedral family. However, it is not easy to guess the space group by inspecting the atomic positions. We can use IrRep for this task:

```
irrep -code=espresso -prefix=Bi2Se3 -onlysym > out
```

The `prefix` option should be indicate the path to the `.save` directory generated by Quantum Espresso, thus it is related to the Quantum Espresso's arguments `outdir` and `prefix`.  With `> out`, we have saved the output of IrRep into a file called `out`. If we open this file with a text editor, we will find:

- A description of the crystal structure parsed from DFT files. We see that the cell used for the DFT calculation was a primitive cell.

- The name of the space group. It is the rhombohedral group R-3m (No. 166). It contains 12 symmetry operations (mod. translations).

- A list of symmetry operations. Each symmetry operation is described by giving the matrix of its rotational part, the vector of the translational part, its action on a generic **k**-point, its rotation axis, angle and whether it respects chirality or not (`inversion` tag).

## Irreducible representations at maximal k-points

IrRep is able calculate the traces of symmetry operations in every **k**-point. Furthermore, if the **k**-point is maximal, IrRep can identify the irreducible representation of every wave function by comparing the traces to the character tables of irreducible representations. For that, we have to run IrRep with the `-kpnames` option:

```
irrep -code=espresso -kpnames=T,GM,F,L -Ecut=50 -IBend=12 -searchcell -spinor -EF=5.2244 > out
```

Let us comment on each argument passed to the command above:

- `code` specifies the interface that should be applied. In this case, it is the interface for VASP (default).

- `kpnames` passes the labels of **k**-points. They should follow the same order as in the file of wave functions (the WAVECAR in this case).

- `Ecut` sets the plane-wave cutoff that will be used for the calculation. Coefficients of plane waves with larger energy will be discarded. Setting it to a value smaller than the cutoff considered in the DFT calculation reduces considerably the time of the calculation.

- `IBend` is the index of the last band considered for the calculation. The convergence of the last bands tends to be poor in DFT, hence it might be convenient to discard them.

- `spinor` indicates that the DFT calculation included SOC.

- `EF` is the Fermi energy. All energy levels will be given with respect to this value. If it is set to `-EF=auto`, IrRep will try to parse it from DFT data and it will set it to 0.0 if it could not find it (the case of VASP).

- `searchcell` is an important parameter. It is used to ask IrRep to determine automatically the transformation from the DFT cell to the conventional cell of the tables. The transformation can alternatively be specified via `-refUC` and `-shiftUC`.

Let us open the file `out` generated by this command and go through the output.

- First, we see the same description of the unit cell and space group that we studied above. However, we can find something that is different: 

    ```
            |   1.0000 -1.0000 -0.0000 |
    refUC = |   0.0000  1.0000 -1.0000 |    shiftUC = [-0. -0. -0.]
            |   1.0000  1.0000  1.0000 |
    ```

    It tells us that the transformation from the DFT cell to the conventional setting. See [IrRep's documentation](https://irrep.dipc.org/cell_transformation.html) for more details.

- Then, we have a block for each maximal **k**-point passed to the code. The header of each block contains the coordinates of the **k**-point in both, the DFT and conventional cell. The number of symmetries in the little group is also written (mod. translations).

    ```
    k-point   1 : [0.5 0.5 0.5] (in DFT cell)
                  [0.  0.  1.5] (after cell trasformation)

    number of states : 12
    ```

    After the header, we can find a list of **energy levels** and **irreducible representations** of identified for each one. The **traces** of symmetries in the little-group are also listed in the same row. The next row contains the traces in the conventional cell.

    ```
       Energy  |   degeneracy  |       irreps       | sym. operations                     
               |               |                    |    1        2        3        4     
     -11.6046  |        2      | -T9(1.0)           |   2.0000   1.0000   1.0000  -0.0000    
               |               |                    |   2.0000   1.0000   1.0000   0.0000 
     -10.0391  |        2      | -T8(1.0)           |   2.0000   1.0000   1.0000   0.0000 
               |               |                    |   2.0000   1.0000   1.0000  -0.0000 
      -1.5692  |        2      | -T9(1.0)           |   2.0000   1.0000   1.0000  -0.0000 
               |               |                    |   2.0000   1.0000   1.0000   0.0000 
      -1.2288  |        2      | -T8(1.0)           |   2.0000   1.0000   1.0000   0.0000 
               |               |                    |   2.0000   1.0000   1.0000  -0.0000 
       0.1380  |        2      | -T6(1.0), -T7(1.0) |   2.0000  -2.0000  -2.0000   0.0000 
               |               |                    |   2.0000  -2.0000  -2.0000  -0.0000 
       0.2922  |        2      | -T8(1.0)           |   2.0000   1.0000   1.0000   0.0000 
               |               |                    |   2.0000   1.0000   1.0000  -0.0000 
    ```

- Finally, the gap with respect to the next set of bands (with index `IBend`+1) is given. Also the number of inversion odd Krammers pairs, if the little group contains inversion.

    ```
    Invariant under inversion: Yes
    Number of inversions-odd Kramers pairs : 3
    Gap with upper bands:  0.5552250943410071
    ```

Once we know the irreps, we can place them on top of a band structure plot, which should be calculated via DFT.

<p align='center'>
<img src="images/bands.png" alt="drawing" width="500"/>
</p>


### Irreps at maximal k-points

Go to the directory `Bi2Se3/IrRep/irreps_maximal-K` and run the command written in `run_irrep.sh`:

```
irrep -code=espresso -prefix=../../DFT/out/bi2se3 -Ecut=50 -kpoints=1,16,31,46 -kpnames=F,GM,L,T -IBend=78 -EF=auto > IrRep.out
```

Alternatively, you could have run `bash run_irrep.sh`, which basically executes the command above. This way, `IrRep` has computed the irreps of valence bands and written them to the file `IrRep.out`. Now, we can place them on top of a band structure plot.

<div align="center">
<figure>
	<img src="./pictures/Bi2Se3_bands_irreps.png"
             alt="Bands Bi2Se3 with irreps">
        <figcaption> Fig. 6: Bands of Bi<sub>2</sub>Se<sub>3</sub> and irreps of valence bands calculated with IrRep </figcaption>
</figure>
</div>
<br/>

In order to determine if the valence bands are topological, we can pass the `trace.txt` file generated by `IrRep` to the software <a href="https://www.cryst.ehu.es/cgi-bin/cryst/programs/magnetictopo.pl?tipog=gesp"> Check Topological Mat </a>. The result is shown in the following picture:

<div align="center">
<figure>
	<img src="./pictures/Bi2Se3_CheckTopologicalMat.png"
             alt="CheckTopologicalMat output for Bi2Se3">
        <figcaption> Fig. 7: Output of ChecktopologicalMat with the file trace.txt generated by IrRep </figcaption>
</figure>
</div>
<br/>

In conclusion, the valence bands of Bi<sub>2</sub>Se<sub>3</sub> are topological and this topology is diagnosed by the following symmetry indicators:

<div align="center">

(*z*<sub>2w,1</sub>, *z*<sub>2w,2</sub>, *z*<sub>2w,3</sub>, *z*<sub>4</sub>) = (0, 0, 0, 3).

</div>

### Separating inversion subspaces

Let's check the calculation of the *z*<sub>4</sub> index by separating inversion even and odd subspaces. For that, we run again the calculation of irreps, but setting the parameter `isymsep` to the index of inversion:

```
irrep -isymsep=7 -code=espresso -prefix=../../DFT/out/bi2se3 -Ecut=300 -kpoints=1,16,31,46 -kpnames=F,GM,L,T -IBend=78 -EF=auto > IrRep.out
```

We read in the output stored in `IrRep.out` the number of inversion-even and odd Kramers pairs at each TRIM:

<div align="center">

   |                 | &Gamma; |  F  |  X  |  L  |
   | :-------------: | ------- | --- | --- | --- | 
   | *N*<sub>+</sub> |    22   |  21 |  21 |  21 | 
   | *N*<sub>-</sub> |    17   |  18 |  18 |  18 | 

</div>

Having in mind that there are 3 non-equivalent points F and X in the BZ, we can apply the formula to calculate the *z*<sub>4</sub> indicator:

<div align="right">

 *z*<sub>4</sub> = ((17 + 3 x 18 + 3 x 18 + 18) - (22 + 3 x 21 + 3 x 21 + 21)) / 2 mod 4 = 3

</div>
